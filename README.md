# Утилита для резервного копирования данных с Livelib.ru

## Описание

Инструмент для автоматического сохранения данных профиля пользователя с книжного портала [Livelib.ru](https://www.livelib.ru). Программа создает резервные копии списков книг (прочитанные, читаю сейчас, хочу прочитать) и пользовательских цитат в формате CSV/Excel без необходимости авторизации.

### Основные возможности

- Резервное копирование всех списков книг пользователя
- Сохранение всех цитат с указанием источника
- Инкрементальное обновление (добавление только новых записей)
- Настраиваемые задержки между запросами для обхода защиты от ботов
- Поддержка двух режимов загрузки: быстрый (requests) и полный (selenium)
- Экспорт в CSV и Excel форматы

## Сохраняемые данные

### Книги
Следующие данные сохраняются в CSV-файл с разделителем табуляции:
- **Наименование** — название книги
- **Автор(ы)** — автор или список авторов
- **Статус** — прочитал/читаю/хочу прочитать
- **Моя оценка** — пользовательская оценка (если указана)
- **Дата прочтения** — дата завершения чтения (если указана)
- **Ссылка** — URL страницы книги на Livelib.ru

### Цитаты
Данные сохраняются в CSV или Excel файл:
- **Наименование книги** — название книги-источника
- **Автор(ы)** — автор книги
- **Цитата** — полный текст цитаты
- **Ссылка на книгу** — URL страницы книги
- **Ссылка на цитату** — URL страницы цитаты

## Установка

### Требования
- Python 3.7 или выше
- pip (менеджер пакетов Python)

### Установка зависимостей

**Linux/macOS:**
```bash
pip3 install -r requirements.txt
```

**Windows:**
```bash
py -m pip install -r requirements.txt
```

## Использование

### Базовый запуск

Где `username` — ваше имя пользователя из ссылки на профиль вида `https://www.livelib.ru/reader/username`

**Linux/macOS:**
```bash
python3 export.py username
```

**Windows:**
```bash
python export.py username
```

### Справка по командам

Для получения полного списка доступных опций:
```bash
python export.py --help
```

### Примеры использования

#### Настройка имен выходных файлов
```bash
python export.py username --books_backup мои_книги.csv --quotes_backup мои_цитаты.xlsx
```

#### Управление задержками между запросами
```bash
# Увеличить задержку для снижения нагрузки на сервер
python export.py username --min_delay 30 --max_delay 60
```

⚠️ **Важно:** Слишком маленькие интервалы между запросами могут привести к блокировке сайтом как бот-активность. Рекомендуемые значения: минимум 5 секунд, максимум 15 секунд.

#### Ограничение количества обрабатываемых страниц
```bash
# Обработать только первые 5 страниц прочитанных книг
python export.py username --read_count 5

# Обработать только первые 10 страниц цитат
python export.py username --quote_count 10
```

#### Полная перезапись файлов
```bash
# Полностью перезаписать существующие файлы (полезно после удаления книг)
python export.py username -R
```

#### Выборочное сохранение данных
```bash
# Сохранить только книги (пропустить цитаты)
python export.py username --skip quotes

# Сохранить только цитаты (пропустить книги)
python export.py username --skip books
```

#### Использование Selenium для JavaScript-контента
```bash
# Использовать браузерный движок для страниц с JavaScript
python export.py username --driver selenium
```

## Режимы работы

### Инкрементальное обновление (по умолчанию)
При повторном запуске программа автоматически определяет новые записи и добавляет только их в существующие файлы. Это позволяет регулярно обновлять резервные копии без дублирования данных.

### Полная перезапись
Флаг `-R` заставляет программу полностью перезаписать файлы. Используйте этот режим, если:
- Вы удалили книги из своих списков на Livelib
- Нужно обновить существующие записи (например, оценки или даты)
- Файлы повреждены или содержат ошибки

## Управление процессом

### Автоматическое завершение
Скрипт автоматически завершается после обработки всех страниц.

### Досрочное завершение
Нажмите `Ctrl+C` в терминале для остановки программы.

⚠️ **Важно:** Если прервать выполнение до завершения обработки секции (например, во время обработки прочитанных книг), изменения в файл **не сохранятся**. Данные записываются только после полной обработки каждой секции:
1. Все статусы книг (прочитал → читаю → хочу прочитать)
2. Все цитаты

## Формат файлов

### Книги (CSV)
- **Разделитель:** табуляция (`\t`)
- **Кодировка:** UTF-8
- **Заголовки:** Name, Author, Status, Rating, Date, Link

Пример:
```
Name	Author	Status	Rating	Date	Link
1984	Джордж Оруэлл	прочитал	5	2024-01-15	https://www.livelib.ru/book/1000038378
```

### Цитаты (CSV/Excel)
- **CSV разделитель:** табуляция (`\t`)
- **Кодировка:** UTF-8
- **Заголовки:** Name, Author, Quote text, Book link, Quote link

Пример:
```
Name	Author	Quote text	Book link	Quote link
1984	Джордж Оруэлл	Война — это мир. Свобода — это рабство. Незнание — сила.	https://www.livelib.ru/book/1000038378	https://www.livelib.ru/quote/123456
```

## Технические особенности

### Защита от блокировки
- Случайные задержки между запросами (5-15 секунд по умолчанию)
- Возможность настройки интервалов через `--min_delay` и `--max_delay`
- Поддержка Selenium для эмуляции браузера

### Обработка ошибок
- Отказоустойчивость: сбой на одной странице не прерывает весь процесс
- Продолжение работы со следующей страницы при ошибке
- Детальное логирование для диагностики проблем

### Поддержка больших объемов данных
- Постраничная обработка списков
- Инкрементальные обновления для экономии времени
- Эффективное использование памяти при обработке цитат

## Тестирование

Проект включает комплексный набор тестов с покрытием основной функциональности.

### Запуск тестов

```bash
# Установка зависимостей для тестирования
pip install pytest pytest-cov

# Запуск всех тестов
pytest

# Запуск с отчетом о покрытии кода
pytest --cov=. --cov-report=html
```

### Статистика тестирования

- **119 тестов** — все успешно проходят (100% pass rate)
- **50% общее покрытие кода**
- **100% покрытие** для основных моделей данных и операций ввода-вывода
- Интеграционные тесты для полных рабочих процессов

Подробная информация о тестировании:
- [Руководство по тестам](tests/README.md) — полное описание тестового покрытия
- [Сводка по тестам](TEST_SUITE_SUMMARY.md) — метрики и статистика

## Устранение неполадок

### Сайт блокирует запросы
- Увеличьте задержки: `--min_delay 30 --max_delay 60`
- Используйте Selenium режим: `--driver selenium`
- Обрабатывайте данные небольшими порциями: `--read_count 5 --quote_count 5`

### Неполные цитаты
Программа автоматически определяет обрезанные цитаты и загружает их полную версию со страницы цитаты.

### Изменения в структуре сайта
Если Livelib изменил структуру HTML, парсинг может не работать. Проверьте наличие обновлений проекта или создайте issue на GitHub.

## Разработка

Для разработчиков доступна подробная документация по архитектуре проекта:
- [CLAUDE.md](CLAUDE.md) — описание архитектуры и компонентов для AI-ассистентов

## Лицензия

Проект распространяется под свободной лицензией. Используйте на свое усмотрение.

## Отказ от ответственности

Этот инструмент предназначен для личного резервного копирования данных. Используйте его ответственно и соблюдайте правила использования портала Livelib.ru. Автор не несет ответственности за возможные блокировки аккаунта при злоупотреблении программой.
